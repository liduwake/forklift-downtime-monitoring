{
  "ruleChain": {
    "name": "forklift manual chain",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null,
    "additionalInfo": {
      "description": ""
    }
  },
  "metadata": {
    "version": 77,
    "firstNodeIndex": 0,
    "nodes": [
      {
        "type": "org.thingsboard.rule.engine.filter.TbMsgTypeSwitchNode",
        "name": "switchmessage",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "version": 0
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 157,
          "layoutY": 311
        }
      },
      {
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "loadattributes",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765314144853
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "tellFailureIfAbsent": false,
          "fetchTo": "METADATA",
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [
            "ss_last_ts",
            "ss_last_status",
            "ss_gala_downtime"
          ],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 387,
          "layoutY": 180
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "forkliftLogicAndDowntime",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765320164881
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "// ===============================================================\r\n// FINAL GALA SCRIPT (VAR-BASED 8 STATE VERSION)\r\n// Statuses: offline, parked, idle, anomaly, standby, working, driving\r\n// ===============================================================\r\n\r\n// ===== Adjustable Threshold =====\r\nvar VAR_THRESHOLD = 25;   // <-- Change this number anytime you want (e.g., 5, 10, 15, 20, 30)\r\n\r\n// ===== 1. Current timestamp =====\r\nvar currentTs = Date.now();\r\n\r\n// ===== 2. Safe input read =====\r\nvar occ = (msg && msg.occ !== undefined) ? Number(msg.occ) : 0;      // Button state\r\nvar mov = (msg && msg.mov !== undefined) ? Number(msg.mov) : 0;      // IMU motion state\r\nvar visible = (msg && msg.visible !== undefined) ? Number(msg.visible) : 1;\r\nvar variance = (msg && msg.var !== undefined) ? Number(msg.var) : 0; // RSSI variance\r\n\r\n// ===== 3. Read memory for downtime =====\r\nvar lastTsRaw = (metadata && metadata[\"ss_ss_last_ts\"]) ? metadata[\"ss_ss_last_ts\"] : 0;\r\nvar lastTs = Number(lastTsRaw);\r\nif (isNaN(lastTs) || lastTs === 0) lastTs = currentTs;\r\n\r\nvar lastStatus = (metadata && metadata[\"ss_ss_last_status\"]) ? metadata[\"ss_ss_last_status\"] : \"parked\";\r\n\r\nvar downtimeRaw = (metadata && metadata[\"ss_ss_gala_downtime\"]) ? metadata[\"ss_ss_gala_downtime\"] : 0;\r\nvar totalDowntime = parseFloat(downtimeRaw);\r\nif (isNaN(totalDowntime)) totalDowntime = 0;\r\n\r\n// ===============================================================\r\n// 4. Determine current status (VAR-based logic)\r\n// ===============================================================\r\nvar currentStatus = \"parked\";\r\n\r\n// Offline override (highest priority)\r\nif (visible === 0) {\r\n    currentStatus = \"offline\";\r\n} \r\nelse {\r\n\r\n    // ---- Button OFF (Vacant) ----\r\n    if (occ === 0) {\r\n        if (mov === 0) {\r\n            currentStatus = \"parked\";      // OFF + Still\r\n        } else {\r\n            if (variance <= VAR_THRESHOLD) currentStatus = \"idle\";     // Stable motion\r\n            else                           currentStatus = \"anomaly\";  // Changing motion\r\n        }\r\n    }\r\n\r\n    // ---- Button ON (Occupied) ----\r\n    else {\r\n        if (mov === 0) {\r\n            currentStatus = \"standby\";       // ON + Still\r\n        } else {\r\n            if (variance <= VAR_THRESHOLD) currentStatus = \"working\";  // Stable\r\n            else                           currentStatus = \"driving\";  // Changing\r\n        }\r\n    }\r\n}\r\n\r\n// ===============================================================\r\n// 5. Downtime calculation\r\n// ===============================================================\r\nvar timeDiffMin = (currentTs - lastTs) / 1000 / 60;\r\nif (timeDiffMin < 0 || timeDiffMin > 60) timeDiffMin = 0;\r\n\r\n// Only working & driving are productive\r\nvar isProductive = (currentStatus === \"driving\" || currentStatus === \"working\");\r\nvar simpleDowntime = (isProductive ? 0 : 1);\r\n\r\nif (simpleDowntime === 1) {\r\n    totalDowntime += timeDiffMin;\r\n}\r\n\r\n// ===============================================================\r\n// 6. Output telemetry\r\n// ===============================================================\r\nmsg.status = currentStatus;\r\nmsg.var_used = variance;  // Output for debugging\r\nmsg.gala_downtime = Number(totalDowntime.toFixed(2));\r\nmsg.simpleDowntime = simpleDowntime;\r\n\r\n// Category mapping (same order as before)\r\nvar category = 7; // unknown\r\n\r\nif (currentStatus === \"driving\") category = 0;\r\nelse if (currentStatus === \"working\") category = 1;\r\nelse if (currentStatus === \"standby\") category = 2;\r\nelse if (currentStatus === \"parked\") category = 3;\r\nelse if (currentStatus === \"idle\") category = 4;\r\nelse if (currentStatus === \"anomaly\") category = 5;\r\nelse if (currentStatus === \"offline\") category = 6;\r\n\r\nmsg.downtime_category = category;\r\n\r\n// ===============================================================\r\n// 7. Save memory\r\n// ===============================================================\r\nmsg.ss_last_ts = currentTs;\r\nmsg.ss_last_status = currentStatus;\r\nmsg.ss_gala_downtime = totalDowntime;\r\n\r\n// ===============================================================\r\nreturn { msg: msg, metadata: metadata, msgType: msgType };\r\n",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 743,
          "layoutY": 191
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "saveDowntimeAttributes",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765194960880
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          },
          "scope": "SERVER_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false,
          "updateAttributesOnlyOnValueChange": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1362,
          "layoutY": 99
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "saveStatusTelemetry",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 0
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "defaultTTL": 0,
          "useServerTs": false,
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1227,
          "layoutY": 288
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "sampler3percent",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765224418747
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "// 3% sampling\r\nreturn Math.random() < 0.03;\r\n",
          "tbelScript": "return msg.temperature > 20;"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 237,
          "layoutY": 508
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "keepRssiVarOnly",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765230394883
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "// Incoming msg example:\r\n// { rssi: -52, anchor: \"A1\" }\r\n\r\nlet anchor = msg.anchor;\r\nlet rssi = msg.rssi;\r\n\r\n// 初始化 metadata，如果没有\r\nif (!metadata) {\r\n    metadata = {};\r\n}\r\n\r\n// 根据 anchor 写入对应的 RSSI\r\nif (anchor === \"A1\") {\r\n    metadata.a1_rssi = rssi;\r\n}\r\nif (anchor === \"A2\") {\r\n    metadata.a2_rssi = rssi;\r\n}\r\nif (anchor === \"A3\") {\r\n    metadata.a3_rssi = rssi;\r\n}\r\n\r\n// 必须返回 metadata！！\r\nreturn {\r\n    msg: msg,\r\n    metadata: metadata,\r\n    msgType: msgType\r\n};\r\n",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 551,
          "layoutY": 509
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "saveRawRssiVar",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765231518080
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "defaultTTL": 0,
          "useServerTs": false,
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 840,
          "layoutY": 509
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "ChangeMsgtype",
        "debugSettings": null,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "// 1. only sellect _db data \r\n// keep Attributes clean without rssi \r\n// newMsg = {\r\n//    \"downtimeTotal_db\": msg.downtimeTotal_db,\r\n//    \"downtimeStartTime_db\": msg.downtimeStartTime_db,\r\n//    \"previousStatus_db\": msg.previousStatus_db\r\n//};\r\n\r\n// 2. change msg type\r\n//return { msg: newMsg, metadata: metadata, msgType: 'POST_ATTRIBUTES_REQUEST' };\r\n// Do NOT modify msg. Just pass through.\r\nreturn {msg: msg, metadata: metadata, msgType: 'POST_ATTRIBUTES_REQUEST'};\r\n",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1057,
          "layoutY": 87
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Trigger Forklift01",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765231291655
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "return {\r\n    msg: { update: 1 },\r\n//    metadata: { targetDeviceName: \"Forklift01\" },\r\n    metadata: {targetDeviceId: \"7dd853c0-d465-11f0-96fc-875ff654df18\"},\r\n    msgType: \"POST_TELEMETRY_REQUEST\"\r\n};\r\n",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1427,
          "layoutY": 610
        }
      },
      {
        "type": "org.thingsboard.rule.engine.flow.TbRuleChainInputNode",
        "name": "trigger",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765229957986
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "forwardMsgToDefaultRuleChain": false,
          "ruleChainId": "ec4fe940-d469-11f0-a9c3-a94cc0e19399"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1437,
          "layoutY": 715
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "calcRssiMerge",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765231291655
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "// calcRssiMerge – safe version\r\n// Input (from saveRawRssiVar):\r\n//   msg:      { anchor: \"A1\", rssi: -65.3, visible: 1, ... }\r\n//   metadata: { deviceName: \"Anchor_A1\", deviceType: \"AnchorProfile\", ts: \"...\" }\r\n// Output (to saveMergedRssi):\r\n//   msg:      原始字段 + max_rssi, nearest_anchor\r\n//   msgType:  固定为 POST_TELEMETRY\r\n\r\nfunction Transform(msg, metadata, msgType) {\r\n\r\n    // ---- 1. 防御：保证 msg 是对象 ----\r\n    if (!msg || typeof msg !== 'object') {\r\n        msg = {};\r\n    }\r\n    if (!metadata || typeof metadata !== 'object') {\r\n        metadata = {};\r\n    }\r\n\r\n    // ---- 2. 读当前这条消息的 anchor / rssi ----\r\n    var anchor = msg.anchor || null;\r\n\r\n    var rssi = null;\r\n    if (typeof msg.rssi === 'number') {\r\n        rssi = msg.rssi;\r\n    } else if (typeof msg.rssi === 'string') {\r\n        var tmp = parseFloat(msg.rssi);\r\n        rssi = isNaN(tmp) ? null : tmp;\r\n    }\r\n\r\n    // ---- 3. 工具：从 metadata 里安全取 / 写浮点数 ----\r\n    function getFloat(name) {\r\n        var v = metadata[name];\r\n        if (v === undefined || v === null || v === '') {\r\n            return null;\r\n        }\r\n        var n = parseFloat(v);\r\n        return isNaN(n) ? null : n;\r\n    }\r\n\r\n    function setFloat(name, val) {\r\n        if (val === undefined || val === null || isNaN(val)) {\r\n            return;\r\n        }\r\n        metadata[name] = String(val);\r\n    }\r\n\r\n    // ---- 4. 取出以前缓存的“最佳值” ----\r\n    var bestRssi   = getFloat('best_rssi');\r\n    var bestAnchor = metadata['best_anchor'] || null;\r\n\r\n    // ---- 5. 用当前 rssi 更新“最强 rssi / 最近 anchor” ----\r\n    if (rssi !== null) {\r\n        // 初始化\r\n        if (bestRssi === null) {\r\n            bestRssi   = rssi;\r\n            bestAnchor = anchor;\r\n        } else {\r\n            // RSSI 越大越近\r\n            if (rssi > bestRssi) {\r\n                bestRssi   = rssi;\r\n                bestAnchor = anchor;\r\n            }\r\n        }\r\n    }\r\n\r\n    // ---- 6. 把最新结果写回 metadata，留给下一条消息用 ----\r\n    setFloat('best_rssi', bestRssi);\r\n    if (bestAnchor) {\r\n        metadata['best_anchor'] = bestAnchor;\r\n    }\r\n\r\n    // ---- 7. 把结果也写到 msg，让 saveMergedRssi 存到 Forklift01 ----\r\n    msg.max_rssi       = bestRssi;\r\n    msg.nearest_anchor = bestAnchor;\r\n\r\n    // ⚠ 关键点：始终返回一个合法对象，msg 绝不能为 null\r\n    return {\r\n        msg: msg,\r\n        metadata: metadata,\r\n        msgType: \"POST_TELEMETRY\"\r\n    };\r\n}\r\n",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1138,
          "layoutY": 505
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "saveMergedRssi",
        "debugSettings": {
          "failuresEnabled": false,
          "allEnabled": false,
          "allEnabledUntil": 1765230978500
        },
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "defaultTTL": 0,
          "useServerTs": false,
          "processingSettings": {
            "type": "ON_EVERY_MESSAGE"
          }
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1398,
          "layoutY": 504
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 1,
        "type": "Post telemetry"
      },
      {
        "fromIndex": 0,
        "toIndex": 5,
        "type": "Post telemetry"
      },
      {
        "fromIndex": 1,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 6,
        "type": "True"
      },
      {
        "fromIndex": 6,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 3,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 10,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 12,
        "type": "Success"
      },
      {
        "fromIndex": 12,
        "toIndex": 9,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}